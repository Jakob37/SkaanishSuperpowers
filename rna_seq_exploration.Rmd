---
title: "R Notebook"
output: html_notebook
---

# Setup

## Load libraries

```{r}
quiet <- suppressPackageStartupMessages

quiet(library(tidyverse))
quiet(library(openxlsx))
quiet(library(DESeq2))
quiet(library(janitor))

theme_set(theme_classic())
```

## Util functions

```{r}
pick <- function(rdf, target_col, as_char=FALSE) {
  target_col <- enquo(target_col)
  raw_col <- rdf %>% dplyr::select(!!target_col) %>% unlist() %>% unname()
  if (as_char) {
    raw_col %>% as.character()
  }
  else {
    raw_col
  }
}
```

## Load data

### Parse from raw data

#### Setup sampling

```{r}
design_seq_df <- openxlsx::read.xlsx("data/GTEx_pancreas_liver_images_liverfat_pancreasfat_seq.xlsx") %>% janitor::clean_names()
design_pat_df <- openxlsx::read.xlsx("data/GTEx_pancreas_liver_images_liverfat_pancreasfat.xlsx")

validation_samples <- sample(nrow(design_seq_df), replace=FALSE, size = 20)

design_seq_df$is_validation_sample <- seq_len(nrow(design_seq_df)) %in% validation_samples

design_seq_df

write.xlsx(design_seq_df, file = "data/design_seq_w_valid.xlsx")

```

#### Setup design

```{r}
design_seq_df <- openxlsx::read.xlsx("data/design_seq_w_valid.xlsx")

pancreas_cols <- colnames(design_seq_df[grepl("_pancreas$", colnames(design_seq_df))])
liver_cols <- colnames(design_seq_df[grepl("_liver$", colnames(design_seq_df))])
tissue_cols_names <- pancreas_cols %>% gsub("_pancreas", "", .)
other_cols <- colnames(design_seq_df)[!colnames(design_seq_df) %in% c(pancreas_cols, liver_cols)]
non_tissue_design_data <- design_seq_df[, !(colnames(design_seq_df) %in% c(pancreas_cols, liver_cols))] %>%
  mutate(id=paste("patient", seq_len(n()), sep="_")) %>% 
  dplyr::select(id, everything())

pancreas_design_distinct <- cbind(
  non_tissue_design_data, 
  design_seq_df[, pancreas_cols] %>% 
    `colnames<-`(tissue_cols_names) %>% mutate(source="pancreas")) %>% 
  distinct(sampid, .keep_all=TRUE) %>%
  mutate(over_median_fat = fat_percentage > median(fat_percentage))

liver_design_distinct <- cbind(
  non_tissue_design_data, design_seq_df[, liver_cols] %>% 
    `colnames<-`(tissue_cols_names) %>% 
    mutate(source="liver")) %>%
  distinct(sampid, .keep_all=TRUE) %>%
  mutate(over_median_fat = fat_percentage > median(fat_percentage))

duplicated(pancreas_design_distinct$sampid)
duplicated(liver_design_distinct$sampid)

ddf <- rbind(pancreas_design_distinct, liver_design_distinct)

message("Any duplicated samples present: ", all(duplicated(ddf$sampid)))

write_tsv(ddf, path="data/count_matrix_target_subset.design.tsv")
```

#### Setup data

```{r eval=FALSE}
raw_df <- read_tsv("data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct", skip = 2)


length(unique(ddf$SAMPID))
length(ddf$SAMPID)

rdf <- raw_df %>% dplyr::select(Name, Description, any_of(ddf$sampid))
write_tsv(rdf, path = "data/count_matrix_target_subset.tsv.gz")

```

### Parse from preparsed data

```{r}
rdf <- read_tsv("data/count_matrix_target_subset.tsv.gz")
ddf_all <- read_tsv("data/count_matrix_target_subset.design.tsv") %>% arrange(sampid)

ddf_all

ddf <- ddf_all %>% filter(sampid %in% colnames(rdf))


```

### Overview the input data

Note that 25 out of 204 samples does not seem to be present in the count matrix.

Four are missing in both types of tissues.

There seem to be duplicate IDs, but that could be due to multiple tissue sample taken from the same person of one type of tissue.

So this could maybe safely be omitted?

But need to think carefully about the statistics!

```{r}
message("Of all samples, how many are present in count data")
table((ddf_all %>% pick(sampid)) %in% colnames(rdf))
message("Of liver samples, how many are present in count data")
present_in_liver <- (ddf_all %>% filter(source == "pancreas") %>% pick(sampid)) %in% colnames(rdf)
table(present_in_liver)
message("Of pancreas samples, how many are present in count data")
present_in_pancreas <- (ddf_all %>% filter(source == "liver") %>% pick(sampid)) %in% colnames(rdf)
table(present_in_pancreas)
message("Of these, how many are missing simultaneously in both?")
table(present_in_liver | present_in_pancreas)
```

# DESeq2 analysis

## Utility functions

```{r}
make_deseq_data <- function(rdf, sample_cols) {
  sdf_dataframe <- rdf %>% dplyr::select(all_of(sort(sample_cols))) %>% as.data.frame()
  rownames(sdf_dataframe) <- rdf$Name
  sdf_dataframe
}

make_deseq_design <- function (ddf_raw, sample_col) {
  ddf_dataframe <- ddf_raw %>% as.data.frame()
  row.names(ddf_dataframe) <- ddf[[sample_col]]
  ddf_dataframe <- ddf_dataframe[sort(rownames(ddf_dataframe)), ]
  ddf_dataframe
}
```

```{r}
ddf$tissue_highfat <- paste(ddf$source, ddf$over_median_fat, sep="_")

ddf_dataframe <- make_deseq_design(ddf, "sampid")
sdf_dataframe <- make_deseq_data(rdf, rownames(ddf_dataframe))

dds <- DESeqDataSetFromMatrix(
  countData = sdf_dataframe,
  colData = ddf_dataframe,
  design = ~tissue_highfat
)

dds_out <- DESeq(dds)

resultsNames(dds_out)

res_liver <- results(dds_out, contrast=c("tissue_highfat", "liver_TRUE", "liver_FALSE"))
res_liver_shrunk <- lfcShrink(dds_out, contrast=c("tissue_highfat", "liver_TRUE", "liver_FALSE"), res=res_liver, type="apeglm")

res_pancreas <- results(dds_out, contrast=c("tissue_highfat", "pancreas_TRUE", "pancreas_FALSE"))
res_pancreas_shrunk <- lfcShrink(dds_out, contrast=c("tissue_highfat", "pancreas_TRUE", "pancreas_FALSE"), res=res_pancreas, type="apeglm")
```

## Writing results prepared for OmicLoupe

```{r}
vsd <- vst(dds_out, blind=FALSE)

adf <- rdf %>% dplyr::select(c("Name", "Description"))
sdf <- rdf %>% dplyr::select(-one_of(c("Name", "Description")))

out_rdf <- cbind(
  adf,
  res_liver %>% data.frame() %>% rename_all(funs(paste("liver", colnames(res_liver), sep="."))),
  res_liver_shrunk %>% data.frame() %>% rename_all(funs(paste("liver_shrunk", colnames(res_liver), sep="."))),
  res_pancreas %>% data.frame() %>% rename_all(funs(paste("panc", colnames(res_liver), sep="."))),
  res_pancreas_shrunk %>% data.frame() %>% rename_all(funs(paste("panc_shrunk", colnames(res_liver), sep="."))),
  assay(vsd)
)

dir.create("output")
write_tsv(out_rdf, path = "output/out_rdf.tsv")

set.seed(37)
write_tsv(out_rdf %>% sample_n(1000, replace = FALSE), path = "output/out_rdf_1000.tsv")
write_tsv(out_rdf %>% sample_n(5000, replace = FALSE), path = "output/out_rdf_5000.tsv")
write_tsv(out_rdf, path = "output/out_rdf.tsv")
write_tsv(ddf %>% dplyr::select(sampid, everything()), path = "output/out_rdf.design.tsv")

out_rdf
```

# Explorative visuals

```{r}
res_liver

phist_liv <- res_liver %>% data.frame() %>%
  ggplot(aes(x=pvalue)) + geom_histogram(bins=100)

phist_panc <- res_pancreas %>% data.frame() %>%
  ggplot(aes(x=pvalue)) + geom_histogram(bins=100)

ggsave(phist_liv, filename = "output/phist_liv.png")
ggsave(phist_panc, filename = "output/phist_panc.png")

res_liver_shrunk %>% data.frame() %>%
  ggplot(aes(x=pvalue)) + geom_histogram(bins=100)

res_pancreas_shrunk %>% data.frame() %>%
  ggplot(aes(x=pvalue)) + geom_histogram(bins=100)


```



```{r}

pca_out <- plotPCA(vsd, intgroup=c("tissue_highfat"))
dir.create("output")

ggsave(pca_out, filename = "output/pca.png")
plotPCA(vsd, intgroup=c("tissue_highfat"), object)

?plotPCA
```

















